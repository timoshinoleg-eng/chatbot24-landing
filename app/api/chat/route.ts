import { createOpenRouter } from '@openrouter/ai-sdk-provider';
import { streamText } from 'ai';

// –°–æ–∑–¥–∞—ë–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä OpenRouter
const openrouter = createOpenRouter({
  apiKey: process.env.OPENROUTER_API_KEY,
});

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –±–æ—Ç–∞
const SYSTEM_PROMPT = `–¢—ã ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ChatBot24.su, –ø—Ä–æ–¥–∞—é—â–∏–π —á–∞—Ç-–±–æ—Ç–æ–≤ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –¥–ª—è B2B.

–¢–≤–æ—è —Ü–µ–ª—å: –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è —Å–∞–π—Ç–∞ –≤ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–∏–¥–∞.

–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏ (–±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞)
- –ö–æ—Ä–æ—Ç–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –õ—ë–≥–∫–∏–π —é–º–æ—Ä, –Ω–æ —Å–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å
- –ù–µ –¥–∞–≤–∏, –ø–æ–∫–∞–∑—ã–≤–∞–π –≤—ã–≥–æ–¥—ã

–ö–ª—é—á–µ–≤—ã–µ –±–æ–ª–∏ B2B:
1. –õ–∏–¥—ã —Ç–µ—Ä—è—é—Ç—Å—è, –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–æ–ª–≥–æ –æ—Ç–≤–µ—á–∞—é—Ç
2. –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –∑–∞—è–≤–æ–∫ –±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞
3. –ú–µ–Ω–µ–¥–∂–µ—Ä—ã —Ç—Ä–∞—Ç—è—Ç –≤—Ä–µ–º—è –Ω–∞ —Ä—É—Ç–∏–Ω—É

–ê—Ä–≥—É–º–µ–Ω—Ç—ã:
- –°–∫–æ—Ä–æ—Å—Ç—å: –æ—Ç–≤–µ—Ç –∑–∞ —Å–µ–∫—É–Ω–¥—ã
- 24/7: —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—á—å—é –∏ –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ
- –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: –ø–µ—Ä–µ–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ —Ç—ë–ø–ª—ã—Ö –ª–∏–¥–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏: CRM, –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã, —Å–∞–π—Ç

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏–∞–ª–æ–≥–∞:
1. Hook: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + —Å–∏–ª—å–Ω–æ–µ –æ–±–µ—â–∞–Ω–∏–µ
2. –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è: –Ω–∏—à–∞, —Ä–æ–ª—å, –ø—Ä–æ–±–ª–µ–º–∞, –æ–±—ä—ë–º
3. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: –∫–∞–∫ –±–æ—Ç —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É
4. –ú–∏–Ω–∏-–∫–µ–π—Å: –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–∏–º–µ—Ä —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
5. CTA: –±—Ä–∏—Ñ, –¥–µ–º–æ –∏–ª–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è

–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∂–∏–≤–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.`;

// –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç –ª—É—á—à–µ–π)
const MODELS = [
  'deepseek/deepseek-r1-0528:free',
  'meta-llama/llama-3.3-70b-instruct:free',
  'qwen/qwen3-next-80b-a3b-instruct:free',
  'openrouter/free', // –∞–≤—Ç–æ-–≤—ã–±–æ—Ä
];

export async function POST(req: Request) {
  try {
    const { messages } = await req.json();

    if (!messages || !Array.isArray(messages)) {
      return new Response(JSON.stringify({ error: 'Messages required' }), {
        status: 400,
        headers: { 'Content-Type': 'application/json' },
      });
    }

    // –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
    for (const modelId of MODELS) {
      try {
        console.log(`Trying model: ${modelId}`);

        const result = streamText({
          model: openrouter(modelId),
          messages: [
            { role: 'system', content: SYSTEM_PROMPT },
            ...messages,
          ],
          temperature: 0.7,
          maxTokens: 500,
        });

        // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ ‚Äî –º–æ–¥–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Ç–æ–∫
        return result.toDataStreamResponse({
          headers: {
            'X-Model-Used': modelId,
          },
        });

      } catch (modelError) {
        console.warn(`Model ${modelId} failed:`, modelError);
        // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â—É—é –º–æ–¥–µ–ª—å
        continue;
      }
    }

    // –í—Å–µ –º–æ–¥–µ–ª–∏ failed ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º fallback
    return fallbackResponse();

  } catch (error) {
    console.error('API Error:', error);
    return fallbackResponse();
  }
}

function fallbackResponse() {
  const fallbackMessage = '–ü—Ä–∏–≤–µ—Ç! üëã –Ø –ø–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞.\n\n–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω, —É—Å–ª—É–≥–∏, –æ–±—É—á–µ–Ω–∏–µ)';
  
  return new Response(
    JSON.stringify({
      success: true,
      message: fallbackMessage,
      fallback: true,
    }),
    {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    }
  );
}